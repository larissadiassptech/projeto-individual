<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vilões | Dashboards</title>

    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/estilo.css" />
    <script src="../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="obterDadosGrafico()">
    <div class="janela">
        <div class="header-left">
            <h1>Vilões</h1>

            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>

            <div class="btn-nav">
                <h3>Gráficos</h3>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>
        </div>

    <div class="dash">
            <h2>Quantidade de votos por vilão</h2>

            <div id="kpis" style="display:flex; gap: 20px; margin-bottom: 20px;">
                <div id="totalVotos">Total de votos: 0</div>
                <div id="maisVotado">Vilão mais votado:</div>
                <div id="percentualMaisVotado">Percentual: 0%</div>
            </div>

            <canvas id="graficoViloes"></canvas>
        </div>
    </div>
<script>
        b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
        function obterDadosGrafico() {
            fetch("/formulario/listar")
                .then(function (resposta) {
                    return resposta.json();
                })
                .then(function (dados) {
                    var labels = [];
                    var valores = [];

                    for (var i = 0; i < dados.length; i++) {
                        labels.push(dados[i].nome_vilao);
                        valores.push(Number(dados[i].quantidades));
                    }

                    atualizarKPIs(dados);
                    plotarGrafico(labels, valores);
                })
                .catch(function (erro) {
                    console.error("Erro ao carregar dados:", erro);
                });
        }
        function plotarGrafico(labels, valores) {
            var canvas = document.getElementById("graficoViloes");

            new Chart(canvas, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Quantidade de votos",
                        data: valores,
                        backgroundColor: [
                            "rgba(153, 102, 255, 0.5)",
                            "rgba(75, 0, 130, 0.5)",
                            "rgba(123, 31, 162, 0.5)",
                            "rgba(106, 13, 173, 0.5)",
                            "rgba(147, 112, 219, 0.5)"
                        ],
                        borderColor: "#4B0082",
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        function atualizarKPIs(dados) {
            var total = 0;
            var maisVotadoQtd = 0;
            var maisVotadoNome = "";

            for (var i = 0; i < dados.length; i++) {
                var qtd = Number(dados[i].quantidades);
                total += qtd;

                if (qtd > maisVotadoQtd) {
                    maisVotadoQtd = qtd;
                    maisVotadoNome = dados[i].nome_vilao;
                }
            }

            var percentual = 0;
            if (total > 0) {
                percentual = ((maisVotadoQtd / total) * 100).toFixed(2);
            }
            document.getElementById("totalVotos").innerHTML = "Total de votos: " + total;
            document.getElementById("maisVotado").innerHTML = "Vilão mais votado: " + maisVotadoNome + " (" + maisVotadoQtd + ")";
            document.getElementById("percentualMaisVotado").innerHTML = "Percentual: " + percentual + "%";
        }
</script>
</body>
</html>
